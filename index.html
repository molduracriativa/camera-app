<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
<title>Moldura Criativa - C√¢mera</title>

<!-- FFmpeg para gerar MP4 -->
<script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.5/dist/ffmpeg.min.js"></script>

<style>
  *{margin:0;padding:0;box-sizing:border-box;}

  html,body{
    width:100%;height:100%;
    background:#000;overflow:hidden;
    -webkit-user-select:none;user-select:none;
    -webkit-touch-callout:none;
    touch-action:manipulation;
    font-family:system-ui,-apple-system;
  }

  #video{
    position:fixed;inset:0;
    width:100vw;height:100vh;
    object-fit:cover;
    z-index:1;
    pointer-events:none;
  }

  /* Moldura */
  #frame{
    position:fixed;inset:0;
    width:100vw;height:100vh;
    object-fit:contain;
    z-index:3;
    pointer-events:none;
  }

  /* Bot√£o ativar c√¢mera */
  #enable{
    position:fixed;left:50%;top:50%;
    transform:translate(-50%,-50%);
    background:#fff;border:none;
    padding:18px 28px;border-radius:12px;
    font-size:20px;z-index:10;
  }

  /* Controles */
  #controls{
    position:fixed;bottom:30px;left:0;right:0;
    display:flex;justify-content:center;gap:40px;
    z-index:10;
  }

  .btn{
    width:70px;height:70px;
    background:#fff;border-radius:50%;
    border:none;font-size:28px;
    display:flex;align-items:center;justify-content:center;
  }
</style>
</head>
<body>

<button id="enable">Ativar C√¢mera</button>

<video id="video" autoplay playsinline muted></video>

<img id="frame" src="assets/moldura.png"/>

<!-- Canvas de renderiza√ß√£o -->
<canvas id="canvas" style="display:none"></canvas>

<div id="controls" style="display:none">
  <button class="btn" id="switch">üîÑ</button>
  <button class="btn" id="photo">üì∏</button>
  <button class="btn" id="record">‚è∫</button>
</div>

<script>
let stream=null;
let front=true;

let recorder=null;
let chunks=[];

const video=document.getElementById("video");
const enable=document.getElementById("enable");
const controls=document.getElementById("controls");
const frame=document.getElementById("frame");
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");

document.addEventListener("touchstart",()=>{}, {passive:true});
document.addEventListener("click",()=>{}, true);


/* ‚õî ABRIR C√ÇMERA */
async function startCam(){
  if(stream) stream.getTracks().forEach(t=>t.stop());

  stream = await navigator.mediaDevices.getUserMedia({
    video:{facingMode: front ? "user" : "environment"},
    audio:true
  });

  video.srcObject=stream;
  await video.play();

  controls.style.display="flex";
  enable.style.display="none";
}

enable.onclick=()=>startCam();


/* üîÑ TROCAR C√ÇMERA */
document.getElementById("switch").onclick=async()=>{
  front=!front;
  await startCam();
};


/* üñºÔ∏è DESENHAR V√çDEO + MOLDURA NO CANVAS */
function drawToCanvas(){
  const vw = video.videoWidth;
  const vh = video.videoHeight;

  canvas.width = 1080;
  canvas.height = 1920;

  const scale = canvas.height / vh;
  const dw = vw * scale;
  const dh = canvas.height;
  const dx = (canvas.width - dw) / 2;

  if(front){
    ctx.save();
    ctx.scale(-1,1);
    ctx.drawImage(video,-dx-dw,0,dw,dh);
    ctx.restore();
  } else {
    ctx.drawImage(video,dx,0,dw,dh);
  }

  const fw = frame.naturalWidth;
  const fh = frame.naturalHeight;
  const fScale = canvas.height / fh;
  const fdw = fw * fScale;
  const fdx = (canvas.width - fdw) / 2;

  ctx.drawImage(frame,fdx,0,fdw,canvas.height);
}


/* üì∏ FOTO */
document.getElementById("photo").onclick=()=>{
  drawToCanvas();
  const a=document.createElement("a");
  a.href=canvas.toDataURL("image/png");
  a.download="foto.png";
  a.click();
};


/* üé• V√çDEO EM MP4 (H.264 + AAC) */
document.getElementById("record").onclick = async () => {

  if (!recorder) {

    const canvasStream = canvas.captureStream(30);
    const audioTracks = stream.getAudioTracks();
    if(audioTracks.length>0) canvasStream.addTrack(audioTracks[0]);

    chunks = [];
    recorder = new MediaRecorder(canvasStream, { mimeType:"video/webm" });

    recorder.ondataavailable = e => chunks.push(e.data);

    recorder.onstop = async () => {

      const webmBlob = new Blob(chunks,{type:"video/webm"});

      const ffmpeg = FFmpeg.createFFmpeg({ log:false });
      await ffmpeg.load();

      const data = await FFmpeg.fetchFile(webmBlob);
      ffmpeg.FS("writeFile","input.webm",data);

      await ffmpeg.run(
        "-i","input.webm",
        "-c:v","libx264",
        "-preset","veryfast",
        "-crf","23",
        "-c:a","aac",
        "-b:a","128k",
        "-movflags","faststart",
        "output.mp4"
      );

      const mp4Data = ffmpeg.FS("readFile","output.mp4");
      const mp4Blob = new Blob([mp4Data.buffer], { type:"video/mp4" });

      const url = URL.createObjectURL(mp4Blob);
      const a=document.createElement("a");
      a.href=url;
      a.download="video.mp4";
      a.click();

      recorder=null;
      document.getElementById("record").textContent="‚è∫";
    };


    function anim(){
      if(recorder){
        drawToCanvas();
        requestAnimationFrame(anim);
      }
    }
    anim();

    recorder.start();
    document.getElementById("record").textContent="‚èπ";

  } else {
    recorder.stop();
  }
};
</script>
</body>
</html>
