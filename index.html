<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
<title>Moldura Criativa - C√¢mera Final</title>

<!-- FFmpeg MP4 -->
<script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.5/dist/ffmpeg.min.js"></script>

<style>
  *{margin:0;padding:0;box-sizing:border-box;}
  html,body{
    width:100%;height:100%;
    background:#000;
    overflow:hidden;
    font-family:system-ui,-apple-system;
    -webkit-user-select:none;user-select:none;
    -webkit-touch-callout:none;
    touch-action:manipulation;
  }

  #video{
    position:fixed;inset:0;
    width:100vw;height:100vh;
    object-fit:cover;
    z-index:1;
    pointer-events:none;
  }

  #frame{
    position:fixed;inset:0;
    width:100vw;height:100vh;
    object-fit:contain;
    z-index:3;
    pointer-events:none;
  }

  #enable{
    position:fixed;left:50%;top:50%;
    transform:translate(-50%,-50%);
    background:#fff;color:#000;
    padding:18px 28px;border:none;
    border-radius:12px;
    font-size:20px;
    z-index:20;
  }

  #controls{
    position:fixed;bottom:30px;left:0;right:0;
    display:none;justify-content:center;
    gap:40px;z-index:10;
  }

  .btn{
    width:80px;height:80px;
    background:#fff;border-radius:50%;
    border:none;font-size:30px;
    display:flex;align-items:center;justify-content:center;
    box-shadow:0 0 20px #0008;
  }

  #timer{
    position:fixed;top:20px;
    left:50%;transform:translateX(-50%);
    font-size:28px;
    color:#fff;display:none;
    z-index:20;font-weight:600;
  }

  #preview{
    position:fixed;inset:0;z-index:30;
    background:#000;
    display:none;
    justify-content:center;
    align-items:center;
  }

  #preview video,#preview img{
    max-width:100%;
    max-height:100%;
    object-fit:contain;
  }

  #preview-buttons{
    position:fixed;bottom:30px;left:0;right:0;
    display:none;justify-content:center;
    gap:40px;z-index:40;
  }

  .pbtn{
    padding:16px 28px;
    background:#fff;border:none;
    border-radius:12px;
    font-size:20px;color:#000;
  }
</style>
</head>
<body>

<button id="enable">Ativar C√¢mera</button>

<video id="video" autoplay playsinline muted></video>
<img id="frame" src="assets/moldura.png"/>

<canvas id="canvas" width="1080" height="1920" style="display:none"></canvas>

<div id="controls">
  <button id="switch" class="btn">üîÑ</button>
  <button id="photo" class="btn">üì∏</button>
  <button id="record" class="btn">‚è∫</button>
</div>

<div id="timer">0.0s</div>

<div id="preview">
  <video id="previewVideo" controls playsinline style="display:none"></video>
  <img id="previewPhoto" style="display:none"/>
</div>

<div id="preview-buttons">
  <button id="save" class="pbtn">Salvar</button>
  <button id="retry" class="pbtn">Refazer</button>
</div>

<script>
let stream=null;
let usingFront=true;
let recorder=null;
let chunks=[];
let elapsed=0;
let timerInt=null;
let videoReady=false;

const video=document.getElementById("video");
const frame=document.getElementById("frame");
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");

const preview=document.getElementById("preview");
const previewVideo=document.getElementById("previewVideo");
const previewPhoto=document.getElementById("previewPhoto");
const previewButtons=document.getElementById("preview-buttons");
const timerEl=document.getElementById("timer");

const enable=document.getElementById("enable");
const controls=document.getElementById("controls");
/* ============================================================
   FUN√á√ÉO PRINCIPAL: ABRIR C√ÇMERA E ESPERAR METADADOS
   ============================================================ */
async function startCamera(){
  try{
    videoReady = false;

    if(stream) stream.getTracks().forEach(t=>t.stop());

    stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode: usingFront ? "user" : "environment" },
      audio:true
    });

    video.srcObject = stream;
    video.muted = true;
    video.setAttribute("playsinline","");

    // üî• ESSENCIAL: esperar videoWidth/videoHeight
    await new Promise(res => {
      video.onloadedmetadata = () => {
        videoReady = true;
        res();
      };
    });

    await video.play();

    enable.style.display="none";
    controls.style.display="flex";

  }catch(err){
    console.error(err);
    alert("Erro ao abrir a c√¢mera: " + err.message);
  }
}

enable.onclick = () => startCamera();

document.getElementById("switch").onclick = async () => {
  usingFront = !usingFront;
  await startCamera();
};

/* ============================================================
   DESENHAR V√çDEO + MOLDURA NO CANVAS
   ============================================================ */
function drawToCanvas(){
  if(!videoReady) return;

  const vw = video.videoWidth;
  const vh = video.videoHeight;

  canvas.width = 1080;
  canvas.height = 1920;

  ctx.fillStyle="#000";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  const scale = canvas.height / vh;
  const dw = vw * scale;
  const dh = canvas.height;
  const dx = (canvas.width - dw) / 2;

  if(usingFront){
    ctx.save();
    ctx.translate(dx + dw, 0);
    ctx.scale(-1,1);
    ctx.drawImage(video, 0,0,vw,vh, 0,0,dw,dh);
    ctx.restore();
  }else{
    ctx.drawImage(video, 0,0,vw,vh, dx,0,dw,dh);
  }

  if(frame.naturalWidth){
    const fw=frame.naturalWidth;
    const fh=frame.naturalHeight;
    const fScale = canvas.height / fh;
    const fdw = fw * fScale;
    const fdx = (canvas.width - fdw) / 2;

    ctx.drawImage(frame,0,0,fw,fh, fdx,0,fdw,canvas.height);
  }
}

/* ============================================================
   FOTO
   ============================================================ */
document.getElementById("photo").onclick = () => {
  if(!videoReady){ alert("Aguarde a c√¢mera abrir."); return; }

  drawToCanvas();
  const dataUrl = canvas.toDataURL("image/png");

  preview.style.display="flex";
  previewButtons.style.display="flex";

  previewVideo.style.display="none";
  previewPhoto.style.display="block";
  previewPhoto.src = dataUrl;

  saveBtn.onclick = () => {
    const a=document.createElement("a");
    a.href=dataUrl;
    a.download="foto.png";
    a.click();
  };

  retryBtn.onclick = () => {
    preview.style.display="none";
    previewButtons.style.display="none";
    previewPhoto.src="";
  };
};

/* ============================================================
   TIMER
   ============================================================ */
function startTimer(){
  elapsed = 0;
  timerEl.style.display="block";

  timerInt = setInterval(()=>{
    elapsed += 0.1;
    timerEl.textContent = elapsed.toFixed(1) + "s";
  },100);
}

function stopTimer(){
  clearInterval(timerInt);
  timerEl.style.display="none";
}

/* ============================================================
   GRAVAR (PRESSIONAR E SEGURAR)
   ============================================================ */
async function startRecording(){
  if(!videoReady){
    console.log("Video not ready");
    return;
  }

  drawToCanvas();

  const canvasStream = canvas.captureStream(30);
  const audioTrack = stream.getAudioTracks()[0];
  if(audioTrack) canvasStream.addTrack(audioTrack);

  chunks = [];
  let options = {};

  const mime='video/webm;codecs=vp8,opus';
  if(MediaRecorder.isTypeSupported(mime)) options.mimeType=mime;

  recorder = new MediaRecorder(canvasStream, options);
  recorder.ondataavailable = e => { if(e.data.size>0) chunks.push(e.data); };

  recorder.onstop = async () => {
    stopTimer();

    const webmBlob = new Blob(chunks, {type:"video/webm"});

    preview.style.display="flex";
    previewButtons.style.display="flex";
    previewVideo.style.display="block";
    previewPhoto.style.display="none";

    try{
      const ffmpeg = FFmpeg.createFFmpeg({log:false});
      await ffmpeg.load();
      ffmpeg.FS('writeFile','input.webm', await FFmpeg.fetchFile(webmBlob));

      await ffmpeg.run(
        "-i","input.webm",
        "-c:v","libx264",
        "-preset","veryfast",
        "-crf","23",
        "-c:a","aac",
        "-b:a","128k",
        "-movflags","faststart",
        "output.mp4"
      );

      const mp4Data = ffmpeg.FS('readFile','output.mp4');
      const mp4Blob = new Blob([mp4Data.buffer], {type:"video/mp4"});
      const url = URL.createObjectURL(mp4Blob);

      previewVideo.src = url;

      saveBtn.onclick = () => {
        const a=document.createElement("a");
        a.href=url;
        a.download="video.mp4";
        a.click();
      };

      retryBtn.onclick = () => {
        preview.style.display="none";
        previewButtons.style.display="none";
        previewVideo.pause();
        previewVideo.src="";
      };

    }catch(e){
      console.error("FFmpeg error", e);
      const url=URL.createObjectURL(webmBlob);
      previewVideo.src=url;
    }

    recorder=null;
  };

  recorder.start();
  startTimer();
}

/* Stop Recording */
function stopRecording(){
  if(recorder && recorder.state !== "inactive"){
    recorder.stop();
  }
}

/* ============================================================
   CONTROLES PRESS & HOLD
   ============================================================ */
const recordBtn=document.getElementById("record");

// Prevenir clique padr√£o
recordBtn.addEventListener("click", e => e.preventDefault());

// In√≠cio da grava√ß√£o
recordBtn.addEventListener("pointerdown", async e => {
  e.preventDefault();
  await startRecording();
});

// Soltar ‚Üí parar grava√ß√£o
recordBtn.addEventListener("pointerup", e => {
  e.preventDefault();
  stopRecording();
});

// Cancelar (dedo arrasta pra fora)
recordBtn.addEventListener("pointercancel", e => {
  e.preventDefault();
  stopRecording();
});

// Fallback para touchstart/end
recordBtn.addEventListener("touchstart", async e => {
  e.preventDefault();
  await startRecording();
},{passive:false});

recordBtn.addEventListener("touchend", e => {
  e.preventDefault();
  stopRecording();
},{passive:false});

recordBtn.addEventListener("touchcancel", e => {
  e.preventDefault();
  stopRecording();
},{passive:false});

</script>
</body>
</html>
