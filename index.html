<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
<title>Molduracamera</title>

<style>
  *{margin:0;padding:0;box-sizing:border-box;}

  html,body{
    width:100%;height:100%;
    background:#000;overflow:hidden;
    -webkit-user-select:none;user-select:none;
    -webkit-touch-callout:none;
    touch-action:manipulation;
    font-family:system-ui,-apple-system;
  }

  #video{
    position:fixed;inset:0;
    width:100vw;height:100vh;
    object-fit:cover;
    z-index:1;
    pointer-events:none;
  }

  #frame{
    position:fixed;inset:0;
    width:100vw;height:100vh;
    object-fit:contain;
    z-index:3;
    pointer-events:none;
  }

  #enable{
    position:fixed;left:50%;top:50%;
    transform:translate(-50%,-50%);
    background:#fff;border:none;
    padding:18px 28px;border-radius:12px;
    font-size:20px;z-index:10;
  }

  #controls{
    position:fixed;bottom:30px;left:0;right:0;
    display:flex;justify-content:center;gap:40px;
    z-index:10;pointer-events:auto;
  }

  .btn{
    width:70px;height:70px;
    background:#fff;border-radius:50%;
    border:none;font-size:28px;
    display:flex;align-items:center;justify-content:center;
    pointer-events:auto;
  }
</style>
</head>
<body>

<button id="enable">Ativar C√¢mera</button>

<video id="video" autoplay playsinline muted></video>

<img id="frame" src="assets/moldura.png"/>

<!-- CANVAS para foto e v√≠deo -->
<canvas id="canvas" style="display:none"></canvas>

<div id="controls" style="display:none">
  <button class="btn" id="switch">üîÑ</button>
  <button class="btn" id="photo">üì∏</button>
  <button class="btn" id="record">‚è∫</button>
</div>

<script>
let stream=null;
let front=true;

let recorder=null;
let chunks=[];

const video=document.getElementById("video");
const enable=document.getElementById("enable");
const controls=document.getElementById("controls");
const frame=document.getElementById("frame");
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");

document.addEventListener("touchstart",()=>{}, {passive:true});
document.addEventListener("click",()=>{}, true);


/* ------------------------------
   Abrir c√¢mera (r√°pido)
--------------------------------*/
async function startCam(){
  if(stream) stream.getTracks().forEach(t=>t.stop());

  stream = await navigator.mediaDevices.getUserMedia({
    video:{facingMode: front ? "user" : "environment"},
    audio:true
  });

  video.srcObject=stream;
  await video.play();

  controls.style.display="flex";
  enable.style.display="none";
}

enable.onclick=()=>startCam();


/* ------------------------------
   Trocar c√¢mera
--------------------------------*/
document.getElementById("switch").onclick=async()=>{
  front=!front;
  await startCam();
};


/* ---------------------------------------------
   Fun√ß√£o que desenha VIDEO + MOLDURA no CANVAS
----------------------------------------------*/
function drawToCanvas(){
  const vw = video.videoWidth;
  const vh = video.videoHeight;

  // ratio 9:16
  canvas.width = 1080;
  canvas.height = 1920;

  // v√≠deo desenhado proporcional pelo height
  const scale = canvas.height / vh;
  const dw = vw * scale;
  const dh = canvas.height;
  const dx = (canvas.width - dw) / 2;

  // desenhar v√≠deo (espelhar se frontal)
  if(front){
    ctx.save();
    ctx.scale(-1,1);
    ctx.drawImage(video,-dx-dw,0,dw,dh);
    ctx.restore();
  }else{
    ctx.drawImage(video,dx,0,dw,dh);
  }

  // desenhar moldura
  const fw = frame.naturalWidth;
  const fh = frame.naturalHeight;
  const fScale = canvas.height / fh;
  const fdw = fw * fScale;
  const fdx = (canvas.width - fdw) / 2;

  ctx.drawImage(frame,fdx,0,fdw,canvas.height);
}


/* ------------------------------
   Tirar FOTO com moldura
--------------------------------*/
document.getElementById("photo").onclick=()=>{
  if(!video.videoWidth) return;

  drawToCanvas(); // aplica moldura

  const a=document.createElement("a");
  a.href=canvas.toDataURL("image/png");
  a.download="foto.png";
  a.click();
};


/* ------------------------------
   Gravar V√çDEO com moldura (r√°pido)
--------------------------------*/
document.getElementById("record").onclick=()=>{

  if(!recorder){
    // gravar direto do canvas
    const streamCanvas = canvas.captureStream(30); 

    // adicionar √°udio
    const audioTracks = stream.getAudioTracks();
    if(audioTracks.length>0){
      streamCanvas.addTrack(audioTracks[0]);
    }

    chunks=[];
    recorder=new MediaRecorder(streamCanvas);

    recorder.ondataavailable=e=>chunks.push(e.data);

    recorder.onstop=()=>{
      const blob=new Blob(chunks,{type:"video/webm"});
      const url=URL.createObjectURL(blob);

      const a=document.createElement("a");
      a.href=url;
      a.download="video.webm";
      a.click();

      recorder=null;
      document.getElementById("record").textContent="‚è∫";
    };

    // **ANIMA√á√ÉO DO CANVAS DURANTE A GRAVA√á√ÉO**
    function anim(){
      if(recorder){
        drawToCanvas();
        requestAnimationFrame(anim);
      }
    }
    anim();

    recorder.start();
    document.getElementById("record").textContent="‚èπ";

  } else {
    recorder.stop();
  }
};
</script>

</body>
</html>
