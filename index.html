<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
<title>Moldura Criativa - C√¢mera de Teste</title>

<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  html, body {
    width:100%; height:100%;
    background:#000;
    overflow:hidden;
    font-family:system-ui, -apple-system;
  }

  /* V√≠deo da c√¢mera */
  #video {
    position:fixed; inset:0;
    width:100vw; height:100vh;
    object-fit:cover;
    z-index:1;
    pointer-events:none;
    background:#000;
  }

  /* Moldura (invis√≠vel neste teste) */
  #frame { display:none; }
  #canvas { display:none; }

  /* Bot√£o ativar c√¢mera */
  #enable {
    position:fixed; left:50%; top:50%;
    transform:translate(-50%, -50%);
    background:#fff; color:#000;
    padding:18px 28px;
    border:none; border-radius:12px;
    font-size:20px;
    z-index:20;
  }

  /* Controles (simplificados para teste) */
  #controls {
    position:fixed; bottom:30px; left:0; right:0;
    display:none; justify-content:center; gap:40px;
    z-index:10;
  }

  .btn {
    width:80px; height:80px;
    background:#fff; border-radius:50%;
    border:none;
    font-size:30px;
    display:flex; align-items:center; justify-content:center;
  }
  
</style>
</head>
<body>

<button id="enable">Ativar C√¢mera</button>

<video id="video" autoplay playsinline muted></video>
<img id="frame" src="assets/moldura.png" alt="Moldura"/> 
<canvas id="canvas" width="540" height="960"></canvas>

<div id="controls">
  <button id="switch" class="btn" disabled>üîÑ</button>
  <button id="photo" class="btn" disabled>üì∏</button>
  <button id="record" class="btn" disabled>‚è∫</button>
</div>


<script>
// --- Vari√°veis Globais ---
let stream=null;
let usingFront=true;
let videoReady=false;

// --- Elementos DOM ---
const video=document.getElementById("video");
const enable=document.getElementById("enable");
const controls=document.getElementById("controls");
const switchBtn = document.getElementById('switch');

// --- A√á√ÉO CR√çTICA: LIGAR A C√ÇMERA ---
async function startCamera(){
  try {
    // 1. Resetar o estado da c√¢mera
    if (stream) {
      stream.getTracks().forEach(t=>t.stop());
      stream = null;
    }

    // 2. Definir as restri√ß√µes (Tenta acessar a c√¢mera e o microfone)
    const constraints = {
      video: { facingMode: usingFront ? 'user' : 'environment', width: { ideal: 1280 }, height: { ideal: 720 } },
      audio: true
    };

    // 3. Obter o stream de m√≠dia (Se isso falhar, o navegador n√£o deu permiss√£o)
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    
    // 4. Configurar o elemento <video>
    video.srcObject = stream;
    video.muted = true;
    video.setAttribute('playsinline', '');

    // 5. Esperar o v√≠deo carregar e tocar
    await new Promise((res, rej) => {
      video.addEventListener('loadedmetadata', () => {
        videoReady = true;
        res();
      }, { once: true });
      setTimeout(() => { if (!videoReady) res(); }, 5000); // Timeout de seguran√ßa
    });
    await video.play();

    // 6. Sucesso: Atualizar a UI
    enable.style.display = 'none';
    controls.style.display = 'flex';
    alert("‚úÖ C√¢mera LIGADA com sucesso!");

  } catch (err) {
    // 7. Falha: Mostrar erro
    console.error('startCamera error', err);
    let errorMessage = 'Erro desconhecido ao acessar c√¢mera.';
    
    // Ajuda a diagnosticar o erro
    if (err.name === 'NotAllowedError') {
        errorMessage = 'Permiss√£o negada. Verifique as configura√ß√µes de c√¢mera do seu navegador e do sistema.';
    } else if (err.name === 'NotFoundError') {
        errorMessage = 'C√¢mera n√£o encontrada no dispositivo.';
    } else if (err.name === 'NotReadableError') {
        errorMessage = 'C√¢mera j√° em uso por outro aplicativo.';
    } else if (err.message) {
        errorMessage = err.message;
    }

    alert(`‚ùå FALHA CR√çTICA: ${errorMessage}`);
  }
}

// --- BINDINGS ---
enable.addEventListener('click', startCamera);

switchBtn.addEventListener('click', async () => {
    usingFront = !usingFront;
    await startCamera();
});

// Ao sair da p√°gina, parar a c√¢mera
window.addEventListener('pagehide', () => {
  try {
    if (stream) stream.getTracks().forEach(t=>t.stop());
  } catch(e){}
});
</script>
</body>
</html>
