<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
<title>Moldura Criativa - C√¢mera</title>

<!-- FFmpeg MP4 Converter -->
<script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.5/dist/ffmpeg.min.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box;}

html,body{
  width:100%;height:100%;
  background:#000;overflow:hidden;
  font-family:system-ui,-apple-system;
  -webkit-user-select:none;user-select:none;
  touch-action:none;
}

/* VIDEO */
#video{
  position:fixed;inset:0;
  width:100vw;height:100vh;
  object-fit:cover;
  z-index:1;
  pointer-events:none;
}

/* FRAME */
#frame{
  position:fixed;inset:0;
  width:100vw;height:100vh;
  object-fit:contain;
  z-index:3;
  pointer-events:none;
}

/* ENABLE CAMERA */
#enable{
  position:fixed;left:50%;top:50%;
  transform:translate(-50%,-50%);
  background:#fff;color:#000;
  padding:18px 28px;border-radius:12px;
  font-size:20px;z-index:10;
  border:none;
}

/* BOTTOM CONTROLS */
#controls{
  position:fixed;left:0;right:0;bottom:30px;
  display:flex;justify-content:center;gap:40px;
  z-index:10;
}

.btn{
  width:80px;height:80px;
  background:#fff;border-radius:50%;
  border:none;font-size:30px;
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 0 10px #0008;
}

/* PREVIEW FULLSCREEN */
#preview{
  position:fixed;inset:0;
  background:#000;
  display:none;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  z-index:20;
}

#preview video,#preview img{
  max-width:100%;
  max-height:100%;
  object-fit:contain;
}

#preview-buttons{
  position:fixed;bottom:30px;display:flex;
  gap:40px;z-index:25;
}

.pbtn{
  background:#fff;border:none;border-radius:12px;
  padding:16px 26px;font-size:20px;
}
#timer{
  position:fixed;top:20px;left:50%;
  transform:translateX(-50%);
  color:#fff;font-size:28px;
  font-weight:600;z-index:15;
  display:none;
}
</style>
</head>
<body>

<button id="enable">Ativar C√¢mera</button>

<video id="video" autoplay playsinline muted></video>

<img id="frame" src="assets/moldura.png"/>

<canvas id="canvas" style="display:none"></canvas>

<div id="controls" style="display:none">
    <button class="btn" id="switch">üîÑ</button>
    <button class="btn" id="photo">üì∏</button>
    <button class="btn" id="record">‚è∫</button>
</div>

<div id="timer">0.0s</div>

<div id="preview">
    <video id="previewVideo" controls style="display:none"></video>
    <img id="previewPhoto" style="display:none"/>
</div>

<div id="preview-buttons" style="display:none">
    <button class="pbtn" id="save">Salvar</button>
    <button class="pbtn" id="retry">Refazer</button>
</div>

<script>
let stream=null;
let front=true;
let recorder=null;
let chunks=[];
let recording=false;
let timerInt=null;
let elapsed=0;

const video=document.getElementById("video");
const frame=document.getElementById("frame");
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");

const enable=document.getElementById("enable");
const controls=document.getElementById("controls");
const timer=document.getElementById("timer");

const preview=document.getElementById("preview");
const previewVideo=document.getElementById("previewVideo");
const previewPhoto=document.getElementById("previewPhoto");
const previewButtons=document.getElementById("preview-buttons");

async function startCam(){
  if(stream) stream.getTracks().forEach(t=>t.stop());

  stream=await navigator.mediaDevices.getUserMedia({
    video:{facingMode:front?"user":"environment"},
    audio:true
  });

  video.srcObject=stream;
  await video.play();
  enable.style.display="none";
  controls.style.display="flex";
}

enable.onclick=()=>startCam();

document.getElementById("switch").onclick=async()=>{
  front=!front;
  await startCam();
};

function drawToCanvas(){
  const vw=video.videoWidth;
  const vh=video.videoHeight;

  canvas.width=1080;
  canvas.height=1920;

  const scale=canvas.height/vh;
  const dw=vw*scale;
  const dh=canvas.height;
  const dx=(canvas.width-dw)/2;

  if(front){
    ctx.save();
    ctx.scale(-1,1);
    ctx.drawImage(video,-dx-dw,0,dw,dh);
    ctx.restore();
  } else {
    ctx.drawImage(video,dx,0,dw,dh);
  }

  const fw=frame.naturalWidth;
  const fh=frame.naturalHeight;
  const fScale=canvas.height/fh;
  const fdw=fw*fScale;
  const fdx=(canvas.width-fdw)/2;

  ctx.drawImage(frame,fdx,0,fdw,canvas.height);
}

document.getElementById("photo").onclick=()=>{
  drawToCanvas();
  const url=canvas.toDataURL("image/png");
  preview.style.display="flex";
  previewButtons.style.display="flex";
  previewPhoto.style.display="block";
  previewVideo.style.display="none";
  previewPhoto.src=url;

  previewButtons.onclick=null;
};

document.getElementById("record").onmousedown=async()=>{
  if(recording) return;
  recording=true;

  elapsed=0;
  timer.style.display="block";
  timer.textContent="0.0s";
  
  timerInt=setInterval(()=>{
    elapsed+=0.1;
    timer.textContent=elapsed.toFixed(1)+"s";
  },100);

  const canvasStream=canvas.captureStream(30);
  const audioTracks=stream.getAudioTracks();
  if(audioTracks.length>0) canvasStream.addTrack(audioTracks[0]);

  chunks=[];
  recorder=new MediaRecorder(canvasStream,{mimeType:"video/webm"});
  recorder.ondataavailable=e=>chunks.push(e.data);
  recorder.start();

  function anim(){
    if(recording){
      drawToCanvas();
      requestAnimationFrame(anim);
    }
  }
  anim();
};

document.getElementById("record").onmouseup=()=>{
  if(!recording) return;
  recording=false;

  timer.style.display="none";
  clearInterval(timerInt);

  recorder.stop();
  recorder.onstop=async()=>{
    const blob=new Blob(chunks,{type:"video/webm"});

    const ffmpeg=FFmpeg.createFFmpeg({log:false});
    await ffmpeg.load();
    ffmpeg.FS("writeFile","input.webm",await FFmpeg.fetchFile(blob));

    await ffmpeg.run(
      "-i","input.webm",
      "-c:v","libx264",
      "-preset","veryfast",
      "-crf","23",
      "-c:a","aac",
      "-b:a","128k",
      "-movflags","faststart",
      "output.mp4"
    );

    const data=ffmpeg.FS("readFile","output.mp4");
    const mp4Blob=new Blob([data.buffer],{type:"video/mp4"});

    preview.style.display="flex";
    previewButtons.style.display="flex";

    previewPhoto.style.display="none";
    previewVideo.style.display="block";

    const url=URL.createObjectURL(mp4Blob);
    previewVideo.src=url;

    document.getElementById("save").onclick=()=>{
      const a=document.createElement("a");
      a.href=url;
      a.download="video.mp4";
      a.click();
    };

    document.getElementById("retry").onclick=()=>{
      preview.style.display="none";
      previewButtons.style.display="none";
      previewVideo.pause();
      previewVideo.src="";
    };
  };
};
</script>
</body>
</html>
