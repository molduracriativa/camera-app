<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Moldura - Foto & V√≠deo MP4 Final</title>

<!-- FFmpeg para MP4 -->
<script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.5/dist/ffmpeg.min.js"></script>

<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body {
    width:100%; height:100%;
    overflow:hidden;
    background:#000;
    font-family: sans-serif;
    -webkit-user-select:none; user-select:none;
  }

  #video, #overlay {
    position:absolute;
    width:100vw; height:100vh;
    object-fit:cover;
  }

  #overlay { pointer-events:none; }

  #buttons {
    position:absolute;
    bottom:40px;
    width:100%;
    display:flex;
    justify-content:center;
    gap:40px;
    z-index:10;
  }

  button {
    width:80px; height:80px;
    border-radius:50%; border:none;
    background:white;
    font-size:28px;
    box-shadow:0 4px 12px rgba(0,0,0,.4);
  }

  #msg {
    position:absolute; top:20px; left:0; right:0;
    text-align:center; color:white; font-weight:bold;
    font-size:18px; z-index:20;
  }

  canvas { display:none; }
</style>
</head>

<body>

<div id="msg"></div>

<video id="video" autoplay playsinline muted></video>
<img id="overlay" src="assets/moldura.png">

<canvas id="canvas"></canvas>

<div id="buttons">
  <button id="photoBtn">üì∏</button>
  <button id="recordBtn">‚è∫</button>
  <button id="switchBtn">üîÑ</button>
</div>

<script>
/* ELEMENTOS */
const video = document.getElementById("video");
const overlay = document.getElementById("overlay");
const canvas = document.getElementById("canvas");
const msg = document.getElementById("msg");

const photoBtn = document.getElementById("photoBtn");
const recordBtn = document.getElementById("recordBtn");
const switchBtn = document.getElementById("switchBtn");

let stream;
let usingFront = true;
let recorder = null;
let chunks = [];

/* =======================================================
    1) ABRIR C√ÇMERA AUTOM√ÅTICO
======================================================= */
async function startCamera() {
  if (stream) stream.getTracks().forEach(t=>t.stop());

  const constraints = {
    video:{
      facingMode: usingFront ? "user" : "environment",
      width:{ideal:1080},
      height:{ideal:1920}
    },
    audio:true
  };

  try {
    stream = await navigator.mediaDevices.getUserMedia(constraints);

    video.srcObject = stream;

    video.style.transform = usingFront ? "scaleX(-1)" : "scaleX(1)";
    overlay.style.transform = "scaleX(1)";

    msg.innerHTML = "C√¢mera pronta!";
    setTimeout(()=> msg.innerHTML="", 1500);

  } catch (e) {
    msg.innerHTML = "Erro ao abrir c√¢mera: " + e.message;
  }
}

startCamera();

/* TROCAR C√ÇMERA */
switchBtn.onclick = ()=>{ usingFront = !usingFront; startCamera(); };


/* =======================================================
    2) FOTO AUTOM√ÅTICA COM MOLDURA
======================================================= */
photoBtn.onclick = async ()=> {
  const track = stream.getVideoTracks()[0];
  const { width, height } = track.getSettings();

  canvas.width = width;
  canvas.height = height;

  const ctx = canvas.getContext("2d");

  if (usingFront) {
    ctx.tr
