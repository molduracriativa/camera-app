<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
<title>Camera com Moldura ‚Äî 9:16 Foto & V√≠deo MP4</title>

<style>
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{
    width:100%;height:100%;
    background:#000;color:#fff;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    -webkit-user-select:none; user-select:none;
    -webkit-touch-callout:none; touch-action:manipulation;
    overflow:hidden;
  }

  #enable-btn{
    position:fixed; left:50%; top:50%;
    transform:translate(-50%,-50%);
    background:#fff; color:#000;
    border:none; padding:16px 26px;
    border-radius:12px; font-size:18px;
    z-index:100000;
    touch-action:manipulation;
  }

  #video {
    display:none;
    position:fixed; inset:0;
    width:100vw; height:100vh;
    object-fit:cover;
    z-index:1;
    pointer-events:none;
  }

  #render-canvas {
    display:none;
    position:fixed; left:50%; top:50%;
    transform:translate(-50%,-50%);
    width:100vw; height:100vh;
    z-index:2;
    background:#000;
    touch-action:none;
    pointer-events:none;
  }

  #overlay { display:none; pointer-events:none; }

  #controls {
    display:none;
    position:fixed;
    bottom:26px; left:0; right:0;
    width:100%;
    justify-content:center;
    gap:18px;
    z-index:100001;
  }
  .btn {
    width:68px; height:68px; border-radius:50%;
    border:none; background:#fff; color:#000;
    box-shadow:0 8px 20px rgba(0,0,0,0.4);
    font-size:26px; display:flex; align-items:center; justify-content:center;
    cursor:pointer;
  }
  .btn.red{ background:#e53935; color:#fff; }

  #preview {
    display:none;
    position:fixed;
    left:50%; bottom:120px;
    transform:translateX(-50%);
    z-index:100002;
    align-items:center;
    gap:10px;
    flex-direction:column;
  }
  #preview video, #preview img {
    width:86vw; max-width:360px; border-radius:10px;
    border:3px solid #fff; background:#000;
    display:block;
  }
  .action-save {
    background:#4CAF50; color:#fff;
    padding:10px 18px; border-radius:8px;
    border:none; font-size:16px;
    cursor:pointer; width:180px;
  }

  #status {
    position:fixed; top:12px; left:12px;
    background:rgba(0,0,0,0.5);
    padding:8px 10px; border-radius:10px;
    z-index:100010; font-size:13px;
    display:none; pointer-events:none; color:#fff;
  }
</style>
</head>
<body>

<button id="enable-btn">Ativar C√¢mera</button>

<video id="video" autoplay playsinline muted></video>
<img id="overlay" src="moldura.png" alt="moldura" />

<canvas id="render-canvas" width="1080" height="1920"></canvas>

<div id="controls">
  <button id="switch-btn" class="btn">üîÑ</button>
  <button id="photo-btn" class="btn">üì∏</button>
  <button id="record-btn" class="btn">üé•</button>
  <button id="stop-btn" class="btn red" style="display:none">‚èπÔ∏è</button>
</div>

<div id="preview">
  <video id="preview-video" controls playsinline style="display:none"></video>
  <img id="preview-photo" style="display:none"/>
  <button id="save-btn" class="action-save">Salvar</button>
  <button id="retry-btn" class="action-save" style="background:#777;margin-top:6px">Tentar novamente</button>
</div>

<div id="status"></div>

<script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.5/dist/ffmpeg.min.js"></script>

<script>
/* ---------- Parte 2: continua√ß√£o do script ---------- */

(async () => {
  /* Elements */
  const enableBtn = document.getElementById('enable-btn');
  const video = document.getElementById('video');
  const overlayImg = document.getElementById('overlay');
  const canvas = document.getElementById('render-canvas');
  const ctx = canvas.getContext('2d');

  const controls = document.getElementById('controls');
  const switchBtn = document.getElementById('switch-btn');
  const photoBtn = document.getElementById('photo-btn');
  const recordBtn = document.getElementById('record-btn');
  const stopBtn = document.getElementById('stop-btn');

  const preview = document.getElementById('preview');
  const previewVideo = document.getElementById('preview-video');
  const previewPhoto = document.getElementById('preview-photo');
  const saveBtn = document.getElementById('save-btn');
  const retryBtn = document.getElementById('retry-btn');

  const statusEl = document.getElementById('status');

  /* State */
  let stream = null;
  let usingFront = true;
  let drawRAF = null;
  let mediaRecorder = null;
  let recordedChunks = [];
  let ffmpeg = null;

  function showStatus(msg, show=true){
    if (show) { statusEl.style.display = 'block'; statusEl.textContent = msg; }
    else { statusEl.style.display = 'none'; }
  }

  // ensure first touch/click counters on mobile
  document.addEventListener('touchstart', ()=>{}, {passive:true});
  document.addEventListener('click', ()=>{}, true);

  function waitForImage(img){
    return new Promise((res, rej) => {
      if (img.complete && img.naturalWidth) return res();
      img.onload = () => res();
      img.onerror = (e) => rej(e);
    });
  }

  async function startCamera(){
    try {
      if (stream) {
        stream.getTracks().forEach(t=>t.stop());
        stream = null;
      }

      const constraints = {
        video: { facingMode: usingFront ? 'user' : 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } },
        audio: true
      };

      showStatus('Abrindo c√¢mera...');
      stream = await navigator.mediaDevices.getUserMedia(constraints);

      video.srcObject = stream;
      video.muted = true;
      video.setAttribute('playsinline','');
      await video.play();

      // ensure overlay loaded
      try { await waitForImage(overlayImg); } catch(e){ console.warn('overlay load failed', e); }

      // set canvas logical resolution to 1080x1920 (portrait)
      canvas.width = 1080;
      canvas.height = 1920;

      // show UI
      video.style.display = 'block';
      canvas.style.display = 'block';
      controls.style.display = 'flex';
      enableBtn.style.display = 'none';
      showStatus('', false);

      // start rendering
      startRenderLoop();
    } catch (err) {
      console.error('startCamera error', err);
      alert('Erro ao abrir c√¢mera: ' + (err && err.message ? err.message : err));
      showStatus('Erro: '+ (err && err.name ? err.name : 'unknown'), true);
    }
  }

  function startRenderLoop(){
    if (drawRAF) return;

    function loop(){
      const W = canvas.width;   // 1080
      const H = canvas.height;  // 1920

      // clear
      ctx.fillStyle = '#000';
      ctx.fillRect(0,0,W,H);

      const vw = video.videoWidth || W;
      const vh = video.videoHeight || H;

      // If video metadata not ready, skip draw
      if (!vw || !vh) {
        drawRAF = requestAnimationFrame(loop);
        return;
      }

      // scale to fill HEIGHT (portrait) - keeps aspect ratio
      const scale = H / vh;
      const drawW = vw * scale;
      const drawH = H;
      const dx = (W - drawW) / 2;

      // draw video (mirror only the video drawing when using front camera)
      if (usingFront) {
        ctx.save();
        // translate to right edge of video region and flip horizontally
        ctx.translate(dx + drawW, 0);
        ctx.scale(-1, 1);
        ctx.drawImage(video, 0, 0, vw, vh, 0, 0, drawW, drawH);
        ctx.restore();
      } else {
        ctx.drawImage(video, 0, 0, vw, vh, dx, 0, drawW, drawH);
      }

      // draw overlay scaled by height and centered horizontally
      if (overlayImg && overlayImg.naturalWidth) {
        const ow = overlayImg.naturalWidth;
        const oh = overlayImg.naturalHeight;
        const oScale = H / oh;
        const oW = ow * oScale;
        const odx = (W - oW) / 2;
        ctx.drawImage(overlayImg, 0, 0, ow, oh, odx, 0, oW, H);
      }

      drawRAF = requestAnimationFrame(loop);
    }

    loop();
  }

  function stopRenderLoop(){
    if (drawRAF) { cancelAnimationFrame(drawRAF); drawRAF = null; }
  }

  /* Photo capture */
  photoBtn.addEventListener('click', async () => {
    if (!canvas.width || !canvas.height) { alert('Aguardando v√≠deo...'); return; }

    // create a copy of the canvas at full logical resolution (1080x1920)
    const tmp = document.createElement('canvas');
    tmp.width = canvas.width;
    tmp.height = canvas.height;
    const tctx = tmp.getContext('2d');
    tctx.drawImage(canvas, 0, 0);

    const dataUrl = tmp.toDataURL('image/png');

    previewVideo.style.display = 'none';
    previewPhoto.style.display = 'block';
    previewPhoto.src = dataUrl;
    preview.style.display = 'flex';
    showStatus('Foto pronta', true);
  });

  /* Recording */
  recordBtn.addEventListener('click', async () => {
    if (!stream) { alert('Abra a c√¢mera primeiro.'); return; }
    if (!drawRAF) startRenderLoop();

    const canvasStream = canvas.captureStream(30);

    // attach audio
    const audioTracks = stream.getAudioTracks();
    if (audioTracks && audioTracks.length) {
      canvasStream.addTrack(audioTracks[0]);
    }

    // choose mime
    let mime = '';
    const cands = [
      'video/webm;codecs=vp8,opus',
      'video/webm;codecs=vp9,opus',
      'video/webm'
    ];
    for (const c of cands) {
      try { if (MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(c)) { mime = c; break; } } catch(e){}
    }

    try {
      recordedChunks = [];
      mediaRecorder = new MediaRecorder(canvasStream, mime ? { mimeType: mime } : undefined);

      mediaRecorder.ondataavailable = (e) => { if (e.data && e.data.size) recordedChunks.push(e.data); };

      mediaRecorder.onstart = () => {
        showStatus('Gravando...');
        recordBtn.style.display = 'none';
        stopBtn.style.display = 'inline-block';
      };

      mediaRecorder.onstop = async () => {
        showStatus('Finalizando grava√ß√£o...');
        const webmBlob = new Blob(recordedChunks, { type: recordedChunks[0]?.type || 'video/webm' });

        try {
          const mp4Blob = await convertWebmToMp4(webmBlob);
          const url = URL.createObjectURL(mp4Blob);
          previewVideo.src = url;
          previewVideo.style.display = 'block';
          previewPhoto.style.display = 'none';
          preview.style.display = 'flex';
          showStatus('V√≠deo pronto (MP4)', true);
        } catch (e) {
          console.error('FFmpeg failed', e);
          const webmUrl = URL.createObjectURL(webmBlob);
          previewVideo.src = webmUrl;
          previewVideo.style.display = 'block';
          previewPhoto.style.display = 'none';
          preview.style.display = 'flex';
          showStatus('V√≠deo pronto (WEBM) ‚Äî convers√£o falhou', true);
        } finally {
          recordBtn.style.display = 'inline-block';
          stopBtn.style.display = 'none';
        }
      };

      mediaRecorder.start();
    } catch (err) {
      console.error('mediaRecorder start error', err);
      alert('N√£o foi poss√≠vel iniciar grava√ß√£o: ' + (err && err.message ? err.message : err));
    }
  });

  stopBtn.addEventListener('click', () => {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
      mediaRecorder.stop();
      showStatus('Parando grava√ß√£o...');
    }
  });

  /* Convert WEBM -> MP4 */
  async function convertWebmToMp4(webmBlob) {
    if (!ffmpeg) {
      showStatus('Carregando ffmpeg (pode demorar)...');
      ffmpeg = FFmpeg.createFFmpeg({ log: false });
      await ffmpeg.load();
    }

    showStatus('Escrevendo arquivo para ffmpeg...');
    const data = await FFmpeg.fetchFile(webmBlob);
    ffmpeg.FS('writeFile', 'input.webm', data);

    showStatus('Convertendo para MP4 (isso pode demorar no celular)...');
    await ffmpeg.run(
      '-i','input.webm',
      '-c:v','libx264',
      '-preset','veryfast',
      '-crf','23',
      '-c:a','aac',
      '-b:a','128k',
      '-movflags','faststart',
      'output.mp4'
    );

    showStatus('Lendo MP4...');
    const mp4Data = ffmpeg.FS('readFile','output.mp4');
    const mp4Blob = new Blob([mp4Data.buffer], { type: 'video/mp4' });

    try { ffmpeg.FS('unlink','input.webm'); ffmpeg.FS('unlink','output.mp4'); } catch(e){}

    return mp4Blob;
  }

  /* Save (photo or video) */
  saveBtn.addEventListener('click', () => {
    if (previewVideo.style.display !== 'none' && previewVideo.src) {
      const a = document.createElement('a');
      a.href = previewVideo.src;
      a.download = 'video.mp4';
      a.click();
      showStatus('Download iniciado', true);
    } else if (previewPhoto.style.display !== 'none' && previewPhoto.src) {
      const a = document.createElement('a');
      a.href = previewPhoto.src;
      a.download = 'foto.png';
      a.click();
      showStatus('Download iniciado', true);
    } else {
      alert('Nada para salvar.');
    }
  });

  retryBtn.addEventListener('click', () => {
    preview.style.display = 'none';
    previewVideo.pause();
    previewVideo.src = '';
    previewPhoto.src = '';
    showStatus('', false);
  });

  switchBtn.addEventListener('click', async () => {
    usingFront = !usingFront;
    try { await startCamera(); } catch (e) { console.error('Erro trocar c√¢mera', e); alert('Erro ao trocar c√¢mera: ' + (e && e.message ? e.message : e)); }
  });

  enableBtn.addEventListener('click', async () => {
    try { await startCamera(); } catch(e){ console.error(e); }
  });

  window.addEventListener('pagehide', () => {
    try {
      if (stream) stream.getTracks().forEach(t=>t.stop());
      stopRenderLoop();
    } catch(e){}
  });

  // initial UI hide handled in HTML/CSS; ready to use
})();
</script>
</body>
</html>
